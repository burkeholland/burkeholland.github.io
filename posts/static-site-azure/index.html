<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>This is how to easily deploy a static site to Azure - Burke Holland</title>
    
    <meta name="description" content="Over the weekend I bought my first new vehicle ever: A red moped. That was the only thing available at my price point.
What a glorious thing it is! The wind whips over your body at a stunning 35 mph and you are alone with your thoughts. You ponder the finer points of the universe: existential questions like, â€œDo I look stupid on this thingâ€, â€œHow many bugs can you eat before you dieâ€ and â€œHow many ways can I deploy a static site to Azureâ€?">
    <meta name="author" content="">
    
    <link href="https://burkeholland.github.io/an-old-hope.min.css" rel="stylesheet">
    <link href="https://burkeholland.github.io/style.css" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="https://burkeholland.github.io/apple-touch-icon.png">
    <link rel="icon" href="https://burkeholland.github.io/favicon.ico">
    
    <meta name="generator" content="Hugo 0.59.1" />
    
    <link rel="alternate" type="application/atom+xml" href="https://burkeholland.github.io/index.xml" title="Burke Holland">
    
    
    
    <script>
      function setTheme() {
        const time = new Date();

        const prev = localStorage.getItem('date');
        const date = String(time.getMonth() + 1) + '.' + String(time.getDate());

        const now = time.getTime();
        let sunrise;
        let sunset;

        function setBodyClass() {
          if (now > sunrise && now < sunset) return;
          document.body.classList.add('dark');
        }

        if (date !== prev) {
          fetch('https://api.ipgeolocation.io/astronomy?apiKey=5ed37d85103e4defa5df4c5298ed5215')
            .then(res => res.json())
            .then(data => {
              sunrise = data.sunrise.split(':').map(Number);
              sunset = data.sunset.split(':').map(Number);
            })
            .catch(() => {
              sunrise = [7, 0];
              sunset = [19, 0];
            })
            .finally(() => {
              sunrise = time.setHours(sunrise[0], sunrise[1], 0);
              sunset = time.setHours(sunset[0], sunset[1], 0);
              setBodyClass();
              localStorage.setItem('sunrise', sunrise);
              localStorage.setItem('sunset', sunset);
            });
          localStorage.setItem('date', date);
        } else {
          sunrise = Number(localStorage.getItem('sunrise'));
          sunset = Number(localStorage.getItem('sunset'));
          setBodyClass();
        }
      }
    </script>
  </head>
  <body class="single">
    <script>
      setTheme();
    </script>
    <header class="header">
      <nav class="nav">
        
        <p class="logo"><a href="https://burkeholland.github.io">&lt; Back</a></p>
        
        
      </nav>
    </header>
    <main class="main">


<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">This is how to easily deploy a static site to Azure</h1>
    <div class="post-meta">May 30, 2019</div>
  </header>
  <div class="post-content">

<p>Over the weekend I bought my first new vehicle ever: A red moped. That was the only thing available at my price point.</p>

<p><img src="https://miro.medium.com/max/1000/1*igNXrT_-JvgxJSeJ745Owg.jpeg" alt="" /></p>

<p>What a glorious thing it is! The wind whips over your body at a stunning 35 mph and you are alone with your thoughts. You ponder the finer points of the universe: existential questions like, â€œDo I look stupid on this thingâ€, â€œHow many bugs can you eat before you dieâ€ and â€œHow many ways can I deploy a static site to Azureâ€?</p>

<h2 id="what-s-a-static-site-moped-boy">Whatâ€™s a static site, moped boy?</h2>

<p>Good question. But can we not call me â€œmoped boyâ€? I mean itâ€™s got 150 CCâ€™s. I can do like 55. Downhill with the wind.</p>

<p>Frameworks like PHP, ASP.NET and Django assemble pages on the fly. When a site is requested, the server performs some queries or operations, assembles the markup and sends a â€œpageâ€ back to you.</p>

<p><img src="https://miro.medium.com/max/600/1*69aS6OhjDU3RBeSRqXiaFA.png" alt="" /></p>

<p>A â€œstatic siteâ€, is any site that is not using a server-side framework. It is just HTML, CSS and JavaScript. These days most static sites are some form of single page application built with Angular, React or Vue (alphabetical order, breathe deeply). I think Iâ€™m supposed to include Svelte in that list now too.</p>

<p><img src="https://miro.medium.com/max/600/1*sar590LUigydRl6LkIqU7Q.png" alt="" /></p>

<p>Iâ€™m not sure why I drew my servers in such a bad mood. I think itâ€™s because thatâ€™s how I would feel if I was a server. Thankless job. Nobody cares until you go down and then everyone is mad you.</p>

<p>â€œSo this article is about how to host an index.html file? Really?â€.</p>

<p>NO. I mean, kind of. Actually, yes.</p>

<h2 id="azure-storage">Azure Storage</h2>

<p><a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blob-static-website?WT.mc_id=personal-medium-buhollan">Azure Storage</a> is specifically designed to serve files as quickly as possible. Static sites are just files. And because God loves you and wants you to be happy, there is VS Code. And because Microsoft loves you, there is an <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurestorage&amp;WT.mc_id=personal-medium-buhollan">Azure Storage extension</a>.</p>

<p>Once itâ€™s installed, you create a storage account. Thatâ€™s pretty straightforward and quick. Short enough to fit in this GIF.</p>

<p><img src="https://miro.medium.com/max/1280/1*Py8u-X-STzMXvL_YKOE1Iw.gif" alt="" /></p>

<p><a href="https://twitter.com/jeffhollan">Jeff Hollan</a> from the Azure Functions team had a cool tweet the other day about naming temporary Resource Groups with â€œdeletemeâ€ and then having a PowerShell function that deletes them every day. This way you can play around and not end up with a bill you werenâ€™t expecting.</p>

<p><blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">When I create a quick demo or repro I preface my resource groups with &quot;deleteme&quot; - but sometimes forget to clean them up. Just wrote a quick PowerShell <a href="https://twitter.com/AzureFunctions?ref_src=twsrc%5Etfw">@AzureFunctions</a> that does it automatically for me every night!  Took about 10 minutes and 10 lines ğŸ‰ <a href="https://t.co/WtJDwgQjcm">pic.twitter.com/WtJDwgQjcm</a></p>&mdash; Jeff Hollan (@jeffhollan) <a href="https://twitter.com/jeffhollan/status/1132774507821748224?ref_src=twsrc%5Etfw">May 26, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>The account will get created and show up in the sidebar under the Storage Extension.</p>

<p><img src="https://miro.medium.com/max/1392/1*6IXOSL6kZcJ3GMizLC3u7g.png" alt="" /></p>

<p>Azure Storage is for serving files, so we need to tell it that we want it to serve our files like a web server. To do that, open the Command Palette and select â€œConfigure static websiteâ€.</p>

<p><img src="https://miro.medium.com/max/1280/1*OB5z_9Wv3mgy2XMrkN76dw.gif" alt="" /></p>

<p>It asks what the â€œindex.htmlâ€ page is. Thatâ€™s usually just â€œindex.htmlâ€. Then it asks for a 404 page. Since we have a single page application, weâ€™re going to direct all traffic back to the â€œindex.htmlâ€ page and handle routing ourselves.</p>

<p>Now we just need to right-click our â€œdistâ€ or â€œbuildâ€ or whatever folder contains the build assets that Webpack made via whatever it is that Webpack does (nobody but <a href="https://twitter.com/TheLarkInn">Sean Larkin</a> knows) and select â€œDeploy To Static Websiteâ€. In this case, Iâ€™m deploying a site that is written in Vue.</p>

<p><img src="https://miro.medium.com/max/1281/1*yGN41vTumZskHeRHOoKYpA.png" alt="" /></p>

<p>And thatâ€™s it. The extension will give you a prompt to browse the website. You will marvel at your own productivity and consider having pizza for a third night in a row. Go ahead. Treat yourself.</p>

<p><img src="https://miro.medium.com/max/1392/1*153NnRgd61tH9U4URyjCNg.png" alt="" /></p>

<p>Azure Storage is the preferred method for hosting a static site. Hereâ€™s whyâ€¦</p>

<ul>
<li>Itâ€™s Simple</li>
<li>Itâ€™s Fast</li>
<li>Itâ€™s Cheap â€” 20 cents per gig of storage per month / 8 cents per gig outbound data transfer, but you get the first 5 gigs every month free.</li>
<li>It automatically scales</li>
<li>ITâ€™S SERVERLESS. I used a buzzword. You have to be convinced now.</li>
</ul>

<h2 id="azure-app-service">Azure App Service</h2>

<p><a href="https://docs.microsoft.com/en-us/azure/app-service/?WT.mc_id=personal-medium-buhollan">App Service</a> is Azureâ€™s Platform as a Service or â€œPaaSâ€. Itâ€™s different from Storage because it provides a runtime for your server-side projects. If you had an ASP.NET application, you would run it in App Service. You canâ€™t run it in Azure Storage because Storage doesnâ€™t know how to run applications.</p>

<p>You can host a static site in App Service, but because itâ€™s designed for much more powerful server-side workflows, We need to sort of â€œfinesseâ€ things a bit.</p>

<p>Kid gloves, people.</p>

<p>Iâ€™m going to do everything via VS Code because thatâ€™s how I want to do everything in my life. I would happily take a VS Code extension for Outlook. Free startup idea right there.</p>

<p><img src="https://miro.medium.com/max/2416/1*Gvs5rpNLh3I6hTMApKe4PQ.png" alt="" /></p>

<p>When you set up a new App Service instance, you can choose from either Linux or Windows hosting in App Service, so Iâ€™m going to cover how to publish your static site to both. And of course, weâ€™re going to do it all from VS Code with the <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azureappservice&amp;WT.mc_id=personal-medium-buhollan">App Service extension</a>.</p>

<h3 id="linux">Linux</h3>

<p>Letâ€™s set up the new site via the VS Code extension.</p>

<p><img src="https://miro.medium.com/max/2560/1*YDJJsQI1h55O-yHkZUFQ_A.gif" alt="" /></p>

<p>Note that I selected â€œLTSâ€ as my Node version. LTS on Azure means that you get whatever the highest Node version that Azure supports is. Whenever Azure supports a newer version, your project will automatically get updated.</p>

<p>App Service for Linux does not come with a baked-in web server. So you canâ€™t just chuck your static site in there. Azure is gonna be like, â€œI donâ€™t know what you want from meâ€. And youâ€™ll be like, â€œI want you to run this siteâ€. And Azure will be like â€œI donâ€™t know howâ€. And youâ€™ll feel like nobody understands you.</p>

<p>To fix that, we need to send a web server up with our files. A simple way to do this is to use the <a href="https://www.npmjs.com/package/serve">serve</a> package from npm.</p>

<p>You also need some way to tell Azure to start â€œserveâ€. You could do that by putting a second <code>package.json</code> file in your â€œdistâ€ folder. But two package JSONâ€™s is kinda ew. Not very ew, but definitely slightly ew.</p>

<p>Instead, we can leverage the fact that Azure bakes <a href="http://pm2.keymetrics.io/">pm2</a> into every Node.js app in App Service. pm2 is a process manager for Node, and you can start apps with it. That means that if we include the right kind of file in our project, Azure will see it and use pm2 to start our project.
Hereâ€™s a video that explains pm2 in a bit more detail just in case youâ€™re new to the pm2 crew.</p>

<p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/hYdSfH-0tVI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>

<p>The file pm2 looks for is called ecoysystem.config.js. In that file, tell pm2 to start â€œserveâ€. Passing the -s flag makes â€œserveâ€ route every request it canâ€™t find back to index.html. We want that because we have a SPA and we are handling all the routing on the client.</p>

<pre><code>module.exports = {
  apps: [
    {
      script: &quot;npx serve -s&quot;
    }
  ]
};
</code></pre>

<p>Iâ€™m also using <code>npx</code> because that keeps me from having to ssh into my instance and install â€œserveâ€ globally.</p>

<p>Drop this file in the â€œdistâ€ folder. Then deploy the â€œdistâ€ folder to Azure. Boom â€” there is your static site. It took me 2 years here at Microsoft to figure out that simple solution. If Vue is your jam, I created a <a href="https://github.com/burkeholland/dead-simple-vue-azure">simple Github repo</a> just for you.</p>

<p>Now I realize that you probably donâ€™t wanna right-click and deploy for the rest of your natural life, so instead of doing that, you can use App Serviceâ€™s ability to build your project for you.
Building With App Service for Linux</p>

<p>If you enable Local Git or GitHub deployment on your site and then check in, Azure will pull the code, run npm install, and then automatically run npm run build. In this case, you would want the ecosystem.config.js file to be at the root and point to the â€œdistâ€ folder that gets created by the build step.</p>

<pre><code>module.exports = {
  apps: [
    {
      script: &quot;npx serve dist -s&quot;
    }
  ]
};
</code></pre>

<p>Now your build is taking place on Azure. All you need to do is check your code into Git â€” Which, letâ€™s be honest, is hard enough as it is. Itâ€™s nice that the rest of this â€œjust worksâ€.</p>

<blockquote>
<p>Note that at the time of this writing, you need to choose Node 10.14.1 in order for the automatic builds to kick in. This should be fixed in LTS shortly (like in a couple of weeks) so Iâ€™m writing it that way to keep it fresh.</p>
</blockquote>

<h3 id="windows">Windows</h3>

<p>On Windows, your site kind of just works. Kind of. This is because Windows for Node.js apps in App Service includes Internet Information Services (IIS), which is perfectly fine with serving up some static files. Hereâ€™s a Windows instance of my app where all I did was deploy the â€œdistâ€ folder.</p>

<p><img src="https://miro.medium.com/max/2784/1*tYRiq9ZPaojmrAossVw7HA.png" alt="" /></p>

<p>Amazing! But â€” there is a problem here. You canâ€™t deep link to your app. So if you tried to go the theurlist.com/build2019 (which is a valid route), you would get thisâ€¦</p>

<p><img src="https://miro.medium.com/max/2784/1*YNFHYjl3YdFVaoDU5lWwow.png" alt="" /></p>

<p>This is because IIS is looking for â€œtheurlist.com/build2019/index.htmlâ€ â€” which does not exist. We need to tell IIS to just route any and all traffic to â€œindex.htmlâ€. To do that, we need to add a web.config to the â€œdistâ€ folder. Inside, define a single routing rule to catch all traffic.</p>

<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;configuration&gt;
  &lt;system.webServer&gt;
    &lt;rewrite&gt;
      &lt;rules&gt;
        &lt;rule name=&quot;Vue&quot; stopProcessing=&quot;true&quot;&gt;
          &lt;match url=&quot;.*&quot; /&gt;
          &lt;conditions logicalGrouping=&quot;MatchAll&quot;&gt;
            &lt;add input=&quot;{REQUEST_FILENAME}&quot; matchType=&quot;IsFile&quot; negate=&quot;true&quot; /&gt;
          &lt;/conditions&gt;
          &lt;action type=&quot;Rewrite&quot; url=&quot;/&quot; /&gt;
        &lt;/rule&gt;
      &lt;/rules&gt;
    &lt;/rewrite&gt;
  &lt;/system.webServer&gt;
&lt;/configuration&gt;
</code></pre>

<p>As before, push the â€œdistâ€ folder into Azure. Note that the automatic builds that we have on Linux do not work for Windows.</p>

<h3 id="azure-web-app-for-containers">Azure Web App for Containers</h3>

<p>Azure App Service actually uses containers under the covers for every site â€” even when you are just deploying your files. For that reason, you can also just deploy a container to App Service.</p>

<p>Make sure you have <a href="https://www.docker.com/">Docker</a> installed. Docker doesnâ€™t work very well if it isnâ€™t installed.</p>

<p>Now is also a good time to tell you toâ€¦.wait for itâ€¦.install the <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-docker&amp;WT.mc_id=ignite2019-urlist-buhollan">Docker extension for VS Code</a>. Come on. You knew that was coming.</p>

<p>First, we need to add a <code>Dockerfile</code> to our project. You can just drop that in the root.</p>

<p><img src="https://miro.medium.com/max/2784/1*yvq3BMrKuf-aMG1arlvlTg.png" alt="" /></p>

<p>To run the site in a container, we need a web server. Since weâ€™re on a Node kick, weâ€™ll just keep working with â€œserveâ€.</p>

<blockquote>
<p>Check out <a href="https://gist.github.com/willurd/5720255">this gist</a> I found that shows you a bunch of different web servers that you can get running for static sites in about one line. Any of these would work in Docker.</p>
</blockquote>

<p>Our Docker file with â€œserveâ€ looks like thisâ€¦</p>

<pre><code>FROM node:alpine

# Copy in dist

COPY ./dist /app

# Install serve

RUN npm i -g serve

# Start it up

CMD serve /app -s
</code></pre>

<p>Build it with VS Code by selecting â€œDocker: Build Imageâ€ from the Command Palette.</p>

<p><img src="https://miro.medium.com/max/2784/1*dFnsJSaDEpvtB0ZyZ3R85A.png" alt="" /></p>

<p>The image will then show up in VS Code under the â€œDockerâ€ explorer.</p>

<p><img src="https://miro.medium.com/max/2784/1*9hyAvTUWZXs9RzYHygnStA.png" alt="" /></p>

<p>Now push it to Docker Hub. To do that, expand the node and right-click the â€œlatestâ€ image and select select â€œtagâ€. You then need to enter your Docker Hub username first. The â€œlatestâ€ tag just means that this is the latest version of this image.
Right-click it again and select â€œPushâ€. This should push it to Docker Hub. If it fails or says â€œAccess Deniedâ€, make sure you are signed into Docker Hub via the terminalâ€¦</p>

<pre><code>$ docker login
</code></pre>

<p>Now that the image is up in Docker Hub, we can pull it into Azure. We need a site to do that. We could configure that through the portal, but thatâ€™sâ€¦not very exciting, so letâ€™s do with the <a href="https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest&amp;WT.mc_id=personal-medium-buhollan">Azure CLI</a>. Also, this article is getting long and my fingers are tired. Your eyes are probably bleeding.</p>

<p>Create a Resource Groupâ€¦</p>

<pre><code>$ az group create -n deleteme-vue-docker
</code></pre>

<p>Create a Service Plan. Remember â€” this is where we choose how much resources we want from Azure. In other words, this is where you spend money.</p>

<pre><code>$ az appservice plan create -n vuedocker -g deleteme-vue-docker â€” is-linux -l â€œEast USâ€ â€” sku S1
</code></pre>

<p>Create the new instance and pull in the container from Docker Hubâ€¦</p>

<pre><code>$ az webapp create -n vue-docker -g deleteme-vue-docker -p vuedocker -i burkeholland/frontend-vue-typescript:latest
</code></pre>

<p>After that command finishes, if you scroll back up through the CLI output, youâ€™ll see the URL of your siteâ€¦</p>

<p><img src="https://miro.medium.com/max/2784/1*Kf0GREvsy7b0Meo6bcXopA.png" alt="" /></p>

<blockquote>
<p>Disclaimer: Itâ€™s a good idea to use a more full-featured web server in production than just â€œserveâ€. The reason for this is that â€œserveâ€ is fairly simple and does not have some of the advanced features you might want in the future. This would be things like gzip or brottli compression, max worker connections, MIME type mappings and more. For that, I would recommend using <a href="https://hub.docker.com/_/nginx/">nginx</a>. Itâ€™s not nearly as simple to setup, but itâ€™s got all the bells and whistles.</p>
</blockquote>

<h2 id="and-done">Andâ€¦..DONE</h2>

<p>Are you still with me? How many people did we lose along the way? Who died of dysentery?</p>

<p>For those who are still awake, alert, alive and enthusiastic, letâ€™s recap what we now know about hosting static sites in Azure.</p>

<ul>
<li>Preferred: Azure Storage</li>
<li>Azure App Service for Linux with an <code>ecosystem.config.js</code> file</li>
<li>Azure App Service for Windows with a <code>web.config</code></li>
<li>Azure App Service with a container</li>
</ul>

<p>Choose your own destiny. Here are some additional links you might find helpful in your static site quest. Godspeed.</p>
</div>
  
  
  
  
  
</article>

</main>
<footer class="footer">
  <span>&copy; 2019 <a href="https://burkeholland.github.io/resume/">Burke Holland</a></span>
</footer>
<script src="https://burkeholland.github.io/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
</body>
</html>

